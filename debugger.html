<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bluetooth Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            min-height: 100vh;
        }
        .status-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        /* Custom scrollbar for better log visibility */
        #log::-webkit-scrollbar {
            width: 8px;
        }
        #log::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container max-w-xl mx-auto flex flex-col items-center justify-start py-8">

        <header class="w-full text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">Bluetooth Connection Debugger</h1>
            <p class="text-gray-500 text-sm">Attempting to establish a connection with open permissions.</p>
        </header>

        <div class="w-full bg-white p-6 rounded-2xl shadow-2xl border border-gray-100">
            
            <!-- Unified Status Card -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">API Support:</span>
                    <span id="api-status" class="font-bold text-sm text-gray-500">Checking...</span>
                </div>
                
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">Connection Status:</span>
                    <span id="connection-state" class="font-bold text-sm text-gray-700">Idle</span>
                </div>
            </div>

            <!-- Action Button -->
            <button id="connect-button" 
                    class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]"
                    onclick="connectSensor()">
                Connect to Sensor Device
            </button>

            <!-- FATAL ERROR DISPLAY (Prominent placement) -->
            <div id="fatal-error-display" class="hidden mt-6 status-box bg-red-100 text-red-800 border border-red-300">
                <p class="font-bold mb-1 text-base">Immediate Failure Detected</p>
                <code id="error-message" class="block bg-red-200 p-2 rounded text-xs whitespace-pre-wrap text-red-900 font-mono"></code>
                <p class="text-sm mt-2">This means the device dialog failed to open. Check OS permissions or system Bluetooth state.</p>
            </div>

            <!-- Detailed Status Log -->
            <h2 class="text-base font-semibold mt-6 mb-3 text-gray-700 border-t pt-4">Activity Log (Newest First)</h2>
            <div id="log" class="bg-gray-50 p-4 rounded-lg border h-48 overflow-y-auto text-sm text-gray-800 space-y-1 font-mono">
                <p class="text-gray-500">Ready to start debugging.</p>
            </div>

        </div>

    </div>

    <script>
        const API_STATUS_ELEM = document.getElementById('api-status');
        const CONNECTION_STATE_ELEM = document.getElementById('connection-state');
        const CONNECT_BUTTON = document.getElementById('connect-button');
        const LOG_ELEM = document.getElementById('log');
        const FATAL_ERROR_DISPLAY = document.getElementById('fatal-error-display');
        const ERROR_MESSAGE_CODE = document.getElementById('error-message');

        /**
         * Utility function to append a message to the log.
         * @param {string} message - The message to log.
         * @param {string} colorClass - Tailwind color class for emphasis (e.g., 'text-green-600').
         */
        function log(message, colorClass = 'text-gray-800') {
            const time = new Date().toLocaleTimeString();
            const p = document.createElement('p');
            p.className = colorClass;
            p.innerHTML = `[${time}] ${message}`;
            LOG_ELEM.prepend(p);
            // Limit log size for performance
            while (LOG_ELEM.children.length > 20) {
                LOG_ELEM.removeChild(LOG_ELEM.lastChild);
            }
        }

        // --- 1. Check for Web Bluetooth Support on Load ---
        function checkBluetoothSupport() {
            if ('bluetooth' in navigator) {
                API_STATUS_ELEM.textContent = 'Supported';
                API_STATUS_ELEM.classList.add('text-green-600');
                log("Web Bluetooth API is available.");
            } else {
                API_STATUS_ELEM.textContent = 'Not Supported';
                API_STATUS_ELEM.classList.add('text-red-600');
                CONNECT_BUTTON.disabled = true;
                log("Web Bluetooth API not found. Please use Chrome/Edge on Desktop/Android.", 'text-red-600');
            }
        }

        // --- 2. Connection Logic ---
        async function connectSensor() {
            if (!('bluetooth' in navigator)) {
                log("Bluetooth API is not available.", 'text-red-600');
                return;
            }
            
            // Hide previous error messages
            FATAL_ERROR_DISPLAY.classList.add('hidden');

            // Clear log for a fresh attempt
            LOG_ELEM.innerHTML = '<p class="text-gray-500">Starting new connection attempt...</p>';

            // Disable button and update UI
            CONNECT_BUTTON.disabled = true;
            CONNECT_BUTTON.textContent = 'Scanning...';
            CONNECTION_STATE_ELEM.textContent = 'Scanning for devices...';
            CONNECTION_STATE_ELEM.classList.remove('text-gray-700', 'text-green-600', 'text-red-600', 'text-yellow-600');
            CONNECTION_STATE_ELEM.classList.add('text-blue-600');
            log("Attempting to request device...", 'text-blue-600');

            try {
                // Using acceptAllDevices: true is necessary for debugging where the failure occurs.
                const options = {
                    acceptAllDevices: true, 
                    optionalServices: [
                        'battery_service', 
                        'generic_access', 
                        // Add your custom UUIDs here if you suspect filtering issues: '12345678-1234-5678-1234-56789abcdef0'
                    ] 
                };
                
                // Request the device - this is the line that should trigger the dialog
                const device = await navigator.bluetooth.requestDevice(options);

                // If the code reaches here, the user selected a device.
                log(`Device found: ${device.name || 'Unnamed Device'}`, 'text-green-700');
                CONNECTION_STATE_ELEM.textContent = 'Device Found';

                // Attempt to connect to the GATT server
                const server = await device.gatt.connect();

                // SUCCESS
                CONNECTION_STATE_ELEM.textContent = 'Connected!';
                CONNECTION_STATE_ELEM.classList.remove('text-blue-600');
                CONNECTION_STATE_ELEM.classList.add('text-green-600');
                CONNECT_BUTTON.textContent = 'Connected (Disconnect?)';
                log(`Successfully connected to GATT server for ${device.name || 'Unnamed Device'}!`, 'text-green-600');
                
            } catch (error) {
                // FAILURE
                CONNECTION_STATE_ELEM.classList.remove('text-blue-600');
                CONNECTION_STATE_ELEM.classList.add('text-red-600');

                if (error.name === 'NotFoundError') {
                    // This is expected if the user clicks cancel or closes the dialog.
                    CONNECTION_STATE_ELEM.textContent = 'Cancelled by User';
                    log("Operation cancelled by user (dialog closed/no device selected).", 'text-yellow-600');
                    CONNECT_BUTTON.textContent = 'Connect to Sensor Device';
                } else {
                    // Immediate, fatal error before dialog appeared or during connection setup.
                    CONNECTION_STATE_ELEM.textContent = 'Connection Failed (Fatal Error)';
                    
                    const fullError = `${error.name}: ${error.message}`;
                    ERROR_MESSAGE_CODE.textContent = fullError;
                    FATAL_ERROR_DISPLAY.classList.remove('hidden');
                    
                    log(`FATAL ERROR: ${fullError}`, 'text-red-600');
                    CONNECT_BUTTON.textContent = 'Connect to Sensor Device (Retry)';
                }
            } finally {
                CONNECT_BUTTON.disabled = false;
            }
        }

        // Run initialization check
        window.onload = checkBluetoothSupport;

    </script>
</body>
</html>
