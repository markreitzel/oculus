<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bluetooth Debugger (v1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            min-height: 100vh;
        }
        .status-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
        /* Custom scrollbar for better log visibility */
        #log::-webkit-scrollbar {
            width: 8px;
        }
        #log::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .action-button {
            @apply w-full py-3 px-4 font-semibold rounded-xl shadow-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01] text-sm;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="container max-w-xl mx-auto flex flex-col items-center justify-start py-8">

        <header class="w-full text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">Bluetooth Connection Debugger (v1)</h1>
            <p class="text-gray-500 text-sm">Attempting to establish a connection with open permissions.</p>
        </header>

        <div class="w-full bg-white p-6 rounded-2xl shadow-2xl border border-gray-100">
            
            <!-- Unified Status Card -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6 space-y-3 text-sm">
                <!-- NEW: API Support and Adapter Status -->
                <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-700">API Support:</span>
                    <span id="api-status" class="font-bold text-gray-500">Checking...</span>
                </div>
                <div class="flex flex-col">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-700">Bluetooth Adapter:</span>
                        <span id="bluetooth-availability" class="font-bold text-gray-500">Checking...</span>
                    </div>
                    <p class="text-xs text-red-500 mt-1 italic" id="adapter-warning" style="display: none;">(Browser status may conflict with OS setting)</p>
                </div>
                <!-- NEW: Location Permission Status (Required on many platforms) -->
                <div class="flex flex-col">
                    <div class="flex justify-between items-center pb-2 border-b border-blue-200">
                        <span class="font-medium text-gray-700">Location Permission:</span>
                        <span id="location-permission-status" class="font-bold text-gray-500">Checking...</span>
                    </div>
                    <p class="text-xs text-yellow-600 mt-1 italic" id="location-hint" style="display: none;">Click "Request Permission" below if status is PROMPT.</p>
                </div>
                
                <!-- Connection Status -->
                <div class="flex justify-between items-center pt-2">
                    <span class="font-medium text-gray-700">Connection Status:</span>
                    <span id="connection-state" class="font-bold text-gray-700">Idle</span>
                </div>
            </div>

            <!-- Permission Request Button -->
            <button id="request-permission-button"
                    class="action-button bg-yellow-600 text-white hover:bg-yellow-700 mb-4"
                    onclick="requestLocationPermission()">
                Request Location Permission
            </button>


            <!-- Action Buttons (New Layout) -->
            <div class="grid grid-cols-3 gap-4">
                <button id="connect-button" 
                        class="action-button bg-blue-600 text-white hover:bg-blue-700"
                        onclick="connectSensor()">
                    Connect
                </button>
                <button id="disconnect-button" 
                        class="action-button bg-gray-400 text-white hover:bg-gray-500"
                        onclick="disconnectSensor()" disabled>
                    Disconnect
                </button>
                <button id="read-button" 
                        class="action-button bg-green-600 text-white hover:bg-green-700"
                        onclick="readData()" disabled>
                    Read Data
                </button>
            </div>

            <!-- FATAL ERROR DISPLAY (Prominent placement) -->
            <div id="fatal-error-display" class="hidden mt-6 status-box bg-red-100 text-red-800 border border-red-300">
                <p class="font-bold mb-1 text-base">Immediate Failure Detected</p>
                <code id="error-message" class="block bg-red-200 p-2 rounded text-xs whitespace-pre-wrap text-red-900 font-mono"></code>
                <p class="text-sm mt-2">This means the device dialog failed to open. Check OS permissions, system Bluetooth state, or try a different browser.</p>
            </div>

            <!-- Detailed Status Log -->
            <h2 class="text-base font-semibold mt-6 mb-3 text-gray-700 border-t pt-4">Activity Log (Newest First)</h2>
            <div id="log" class="bg-gray-50 p-4 rounded-lg border h-48 overflow-y-auto text-sm text-gray-800 space-y-1 font-mono">
                <p class="text-gray-500">Ready to start debugging.</p>
            </div>

        </div>

    </div>

    <script>
        const API_STATUS_ELEM = document.getElementById('api-status');
        const BLUETOOTH_AVAILABILITY_ELEM = document.getElementById('bluetooth-availability');
        const ADAPTER_WARNING_ELEM = document.getElementById('adapter-warning');
        const LOCATION_PERMISSION_ELEM = document.getElementById('location-permission-status');
        const LOCATION_HINT_ELEM = document.getElementById('location-hint');
        const REQUEST_PERMISSION_BUTTON = document.getElementById('request-permission-button');
        const CONNECTION_STATE_ELEM = document.getElementById('connection-state');
        const CONNECT_BUTTON = document.getElementById('connect-button');
        const DISCONNECT_BUTTON = document.getElementById('disconnect-button');
        const READ_BUTTON = document.getElementById('read-button');
        const LOG_ELEM = document.getElementById('log');
        const FATAL_ERROR_DISPLAY = document.getElementById('fatal-error-display');
        const ERROR_MESSAGE_CODE = document.getElementById('error-message');

        let g_device = null; // Global variable to store the connected device object

        /**
         * Utility function to append a message to the log.
         * @param {string} message - The message to log.
         * @param {string} colorClass - Tailwind color class for emphasis (e.g., 'text-green-600').
         */
        function log(message, colorClass = 'text-gray-800') {
            const time = new Date().toLocaleTimeString();
            const p = document.createElement('p');
            p.className = colorClass;
            p.innerHTML = `[${time}] ${message}`;
            LOG_ELEM.prepend(p);
            // Limit log size for performance
            while (LOG_ELEM.children.length > 20) {
                LOG_ELEM.removeChild(LOG_ELEM.lastChild);
            }
        }

        /**
         * Updates the state of the buttons and connection status display.
         * @param {string} state - 'idle', 'scanning', 'connected', 'cancelled', or 'error'.
         * @param {string} message - Optional error message snippet.
         */
        function updateUIState(state, message = '') {
            CONNECTION_STATE_ELEM.classList.remove('text-gray-700', 'text-green-600', 'text-red-600', 'text-yellow-600', 'text-blue-600');
            
            switch (state) {
                case 'idle':
                    CONNECTION_STATE_ELEM.textContent = 'Idle';
                    CONNECTION_STATE_ELEM.classList.add('text-gray-700');
                    CONNECT_BUTTON.disabled = false;
                    DISCONNECT_BUTTON.disabled = true;
                    READ_BUTTON.disabled = true;
                    break;
                case 'scanning':
                    CONNECTION_STATE_ELEM.textContent = 'Scanning...';
                    CONNECTION_STATE_ELEM.classList.add('text-blue-600');
                    CONNECT_BUTTON.disabled = true;
                    DISCONNECT_BUTTON.disabled = true;
                    READ_BUTTON.disabled = true;
                    break;
                case 'connected':
                    CONNECTION_STATE_ELEM.textContent = `Connected to ${g_device.name || 'Device'}`;
                    CONNECTION_STATE_ELEM.classList.add('text-green-600');
                    CONNECT_BUTTON.disabled = true;
                    DISCONNECT_BUTTON.disabled = false;
                    READ_BUTTON.disabled = false;
                    break;
                case 'cancelled':
                    CONNECTION_STATE_ELEM.textContent = 'Cancelled by User';
                    CONNECTION_STATE_ELEM.classList.add('text-yellow-600');
                    CONNECT_BUTTON.disabled = false;
                    DISCONNECT_BUTTON.disabled = true;
                    READ_BUTTON.disabled = true;
                    break;
                case 'error':
                    CONNECTION_STATE_ELEM.textContent = `Failed (${message})`;
                    CONNECTION_STATE_ELEM.classList.add('text-red-600');
                    CONNECT_BUTTON.disabled = false;
                    DISCONNECT_BUTTON.disabled = true;
                    READ_BUTTON.disabled = true;
                    break;
            }
        }
        
        // --- Function to request location permission (to change status from PROMPT) ---
        function requestLocationPermission() {
            if ('geolocation' in navigator) {
                log("Requesting Geolocation permission to satisfy Bluetooth scan requirement...", 'text-yellow-700');
                
                // This call triggers the native permission prompt
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        log(`Geolocation succeeded. Permission is likely GRANTED. Lat: ${position.coords.latitude}`, 'text-green-600');
                        checkLocationPermission(); // Re-check status
                    },
                    (error) => {
                        // This fires if permission is denied, or if location services are disabled on OS
                        if (error.code === error.PERMISSION_DENIED) {
                            log("Geolocation FAILED. Permission was DENIED or blocked.", 'text-red-600');
                        } else {
                            log(`Geolocation failed unexpectedly: ${error.message}`, 'text-red-500');
                        }
                        checkLocationPermission(); // Re-check status
                    },
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
                );
            } else {
                log("Geolocation API not available in this browser.", 'text-gray-500');
            }
        }
        
        // --- 1. Check for Web Bluetooth Support on Load ---
        async function checkLocationPermission() {
            if ('permissions' in navigator) {
                try {
                    const permissionStatus = await navigator.permissions.query({ name: 'geolocation' });
                    LOCATION_PERMISSION_ELEM.textContent = permissionStatus.state.toUpperCase();
                    LOCATION_PERMISSION_ELEM.classList.remove('text-gray-500', 'text-green-600', 'text-yellow-600', 'text-red-600');
                    LOCATION_HINT_ELEM.style.display = 'none';

                    if (permissionStatus.state === 'granted') {
                        LOCATION_PERMISSION_ELEM.classList.add('text-green-600');
                        REQUEST_PERMISSION_BUTTON.disabled = true;
                        REQUEST_PERMISSION_BUTTON.textContent = 'Permission Granted';
                        log("Location permission confirmed as GRANTED. Ready for Bluetooth scan.", 'text-green-600');
                    } else if (permissionStatus.state === 'prompt') {
                        LOCATION_PERMISSION_ELEM.classList.add('text-yellow-600');
                        LOCATION_HINT_ELEM.style.display = 'block';
                        REQUEST_PERMISSION_BUTTON.disabled = false;
                        REQUEST_PERMISSION_BUTTON.textContent = 'Request Location Permission';
                        log("Location permission is 'PROMPT'. Click the button to request permission.", 'text-yellow-600');
                    } else { // 'denied'
                        LOCATION_PERMISSION_ELEM.classList.add('text-red-600');
                        REQUEST_PERMISSION_BUTTON.disabled = true;
                        REQUEST_PERMISSION_BUTTON.textContent = 'Permission Denied';
                        log("Location permission is 'DENIED'. This will block Bluetooth scanning.", 'text-red-600');
                    }
                } catch (e) {
                    LOCATION_PERMISSION_ELEM.textContent = 'N/A';
                    LOCATION_PERMISSION_ELEM.classList.add('text-gray-500');
                    log("Location permission check failed (Permissions API error).", 'text-gray-500');
                    REQUEST_PERMISSION_BUTTON.disabled = true;
                }
            } else {
                LOCATION_PERMISSION_ELEM.textContent = 'N/A';
                LOCATION_PERMISSION_ELEM.classList.add('text-gray-500');
                REQUEST_PERMISSION_BUTTON.disabled = true;
            }
        }
        
        async function checkBluetoothSupport() {
            // 1. Check API support
            if (!('bluetooth' in navigator)) {
                API_STATUS_ELEM.textContent = 'Not Supported';
                API_STATUS_ELEM.classList.add('text-red-600');
                CONNECT_BUTTON.disabled = true;
                log("Web Bluetooth API not found. Please use Chrome/Edge on Desktop/Android.", 'text-red-600');
                return;
            }
            API_STATUS_ELEM.textContent = 'Supported';
            API_STATUS_ELEM.classList.add('text-green-600');
            log("Web Bluetooth API is available.");


            // 2. Check Adapter Availability
            try {
                const available = await navigator.bluetooth.getAvailability();
                BLUETOOTH_AVAILABILITY_ELEM.textContent = available ? 'ON' : 'OFF';
                BLUETOOTH_AVAILABILITY_ELEM.classList.remove('text-gray-500');
                
                if (available) {
                    BLUETOOTH_AVAILABILITY_ELEM.classList.add('text-green-600');
                    ADAPTER_WARNING_ELEM.style.display = 'none';
                } else {
                    BLUETOOTH_AVAILABILITY_ELEM.classList.add('text-red-600');
                    ADAPTER_WARNING_ELEM.style.display = 'block';
                    log("Browser reports Bluetooth radio as OFF via API. Note: This status may conflict with your OS settings.", 'text-red-500');
                }
            } catch (e) {
                BLUETOOTH_AVAILABILITY_ELEM.textContent = 'Unknown/Error';
                BLUETOOTH_AVAILABILITY_ELEM.classList.add('text-red-500');
                ADAPTER_WARNING_ELEM.style.display = 'none';
                log(`Failed to check Bluetooth availability: ${e.message}`, 'text-red-500');
            }


            // 3. Check Location Permission (Now separate, async function)
            await checkLocationPermission();
            
            updateUIState('idle'); // Set initial state
        }

        // --- 2. Connection Logic ---
        async function connectSensor() {
            if (!('bluetooth' in navigator)) return;
            
            FATAL_ERROR_DISPLAY.classList.add('hidden');
            LOG_ELEM.innerHTML = '<p class="text-gray-500">Starting new connection attempt...</p>';
            updateUIState('scanning');
            log("Attempting to request device...", 'text-blue-600');
            
            // Diagnostic check right before calling the API
            const locStatus = LOCATION_PERMISSION_ELEM.textContent;
            log(`Current Location Permission state before request: ${locStatus}`, locStatus === 'GRANTED' ? 'text-green-600' : 'text-red-600');

            try {
                // Using acceptAllDevices: true for maximum compatibility
                // Removed optionalServices array to ensure the broadest possible scan filter
                const options = {
                    acceptAllDevices: true, 
                };
                
                // Request the device - this is the line that should trigger the dialog
                const device = await navigator.bluetooth.requestDevice(options);

                // Add listener for unexpected disconnects
                device.addEventListener('gattserverdisconnected', onDeviceDisconnected);

                g_device = device;
                log(`Device found: ${device.name || 'Unnamed Device'}`, 'text-blue-500');

                // Attempt to connect to the GATT server
                await device.gatt.connect();

                // SUCCESS
                updateUIState('connected');
                log(`Successfully connected to GATT server for ${device.name || 'Unnamed Device'}!`, 'text-green-600');
                
            } catch (error) {
                g_device = null; // Clear device on failure
                if (error.name === 'NotFoundError') {
                    updateUIState('cancelled');
                    // This is the key log: If the user says they didn't cancel, this means the dialog failed to appear due to a system issue (like permissions or adapter state)
                    log("Operation cancelled by user (dialog closed/no device selected). If you did not cancel, this indicates a failure to launch the OS device dialog.", 'text-yellow-600');
                } else {
                    updateUIState('error', error.name);
                    
                    const fullError = `${error.name}: ${error.message}`;
                    ERROR_MESSAGE_CODE.textContent = fullError;
                    FATAL_ERROR_DISPLAY.classList.remove('hidden');
                    
                    log(`FATAL ERROR: ${fullError}`, 'text-red-600');
                }
            }
        }

        // --- 3. Disconnection Logic ---
        function disconnectSensor() {
            if (g_device && g_device.gatt.connected) {
                g_device.gatt.disconnect();
                // onDeviceDisconnected will handle the UI update
            } else {
                log("Device is already disconnected or not available.", 'text-gray-500');
                updateUIState('idle');
            }
        }

        // --- 4. Disconnect Event Handler ---
        function onDeviceDisconnected(event) {
            const device = event.target;
            log(`Device ${device.name || 'Unnamed Device'} disconnected.`, 'text-red-400');
            g_device = null;
            updateUIState('idle');
        }

        // --- 5. Read Data Placeholder (Further Interaction) ---
        function readData() {
            if (!g_device || !g_device.gatt.connected) {
                log("Cannot read data: Not connected.", 'text-red-500');
                updateUIState('error', 'Not connected');
                return;
            }
            log("Attempting to read data... (Placeholder function)", 'text-green-500');
            // In a real application, you would perform getPrimaryService, getCharacteristic, and readValue here.
            log("Data read simulated. Needs real GATT interaction.", 'text-green-500');
        }

        // Run initialization check
        window.onload = checkBluetoothSupport;

    </script>
</body>
</html>
